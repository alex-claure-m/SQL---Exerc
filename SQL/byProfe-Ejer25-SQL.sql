-- EJERCICIO 25 con subselect correlacionados en el select, having y order by

SELECT YEAR(f.fact_fecha) AS Año, P.prod_familia,(SELECT COUNT(DISTINCT P2.prod_rubro) FROM Producto P2 WHERE P2.prod_familia = P.prod_familia) AS Rubros,(SELECT COUNT(*) FROM Composicion C INNER JOIN Producto p2 ON c.comp_producto = p2.prod_codigo WHERE P2.prod_familia = P.prod_familia) AS Componentes,(SELECT COUNT(DISTINCT CONCAT(f2.fact_tipo,f2.fact_sucursal,f2.fact_numero)) FROM Item_Factura i2 INNER JOIN Producto p2 ON i2.item_producto = p2.prod_codigoINNER JOIN Factura f2 ON f2.fact_tipo = i2.item_tipo AND f2.fact_sucursal = i2.item_sucursal AND f2.fact_numero = i2.item_numero  WHERE p2.prod_familia = P.prod_familia AND YEAR(f2.fact_fecha) = YEAR(f.fact_fecha) ) AS FacturasFROM Producto P
INNER JOIN Item_Factura I ON P.prod_codigo = I.item_producto INNER JOIN Factura F ON f.fact_tipo = i.item_tipo AND f.fact_sucursal = i.item_sucursal AND f.fact_numero = i.item_numeroGROUP BY YEAR(f.fact_fecha), P.prod_familia HAVING P.prod_familia = (SELECT TOP 1 P2.prod_familiaFROM Producto P2 INNER JOIN Item_Factura I2 ON P2.prod_codigo = I2.item_producto INNER JOIN Factura F2 ON f2.fact_tipo = i2.item_tipo AND f2.fact_sucursal = i2.item_sucursal AND f2.fact_numero = i2.item_numeroWHERE YEAR(f2.fact_fecha) = YEAR(f.fact_fecha)GROUP BY P2.prod_familia ORDER BY SUM(i2.item_cantidad) DESC)ORDER BY (SELECT SUM(f2.fact_total) FROM Item_Factura i2 INNER JOIN Producto p2 ON i2.item_producto = p2.prod_codigoINNER JOIN Factura f2 ON f2.fact_tipo = i2.item_tipo AND f2.fact_sucursal = i2.item_sucursal AND f2.fact_numero = i2.item_numero  WHERE YEAR(f2.fact_fecha) = YEAR(f.fact_fecha)) desc, P.prod_familia desc
